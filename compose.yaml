# Copyright (c) 2025 CodeLibs
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Assera Docker Compose - Production/Distribution Configuration
# External access: assera-ui only (port 3000)
# All other services communicate via internal network

x-health: &curl-health
  test: ["CMD-SHELL", "curl -fsS $$HEALTH_URL || exit 1"]
  interval: 10s
  timeout: 5s
  retries: 30

networks:
  assera-net:
    driver: bridge

services:
  opensearch:
    image: ghcr.io/codelibs/fess-opensearch:3.2.0
    container_name: assera-opensearch
    environment:
      - node.name=assera-opensearch
      - discovery.seed_hosts=assera-opensearch
      - cluster.initial_cluster_manager_nodes=assera-opensearch
      - cluster.name=fess-search
      - bootstrap.memory_lock=true
      - node.roles=cluster_manager,data,ingest,ml
      - "OPENSEARCH_JAVA_OPTS=${OPENSEARCH_JAVA_OPTS:- -Xms1g -Xmx1g}"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - "DISABLE_SECURITY_PLUGIN=true"
      - "FESS_DICTIONARY_PATH=/usr/share/opensearch/config/dictionary"
      - TZ=${TZ:-Asia/Tokyo}
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65535
        hard: 65535
    volumes:
      - ./data/opensearch:/usr/share/opensearch/data
      - ./data/dictionary:/usr/share/opensearch/config/dictionary
    networks:
      - assera-net
    healthcheck:
      <<: *curl-health
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health || exit 1"]
    restart: unless-stopped

  fess:
    image: ghcr.io/codelibs/fess:15.2.0
    container_name: assera-fess
    depends_on:
      opensearch:
        condition: service_healthy
    environment:
      - SEARCH_ENGINE_HTTP_URL=http://assera-opensearch:9200
      - FESS_DICTIONARY_PATH=${FESS_DICTIONARY_PATH:-/usr/share/opensearch/config/dictionary/}
      - TZ=${TZ:-Asia/Tokyo}
    networks:
      - assera-net
    expose:
      - "8080"
    healthcheck:
      <<: *curl-health
      test: ["CMD-SHELL", "curl -fsS 'http://localhost:8080/api/v1/health' || exit 1"]
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    container_name: assera-ollama
    networks:
      - assera-net
    volumes:
      - ./data/ollama:/root/.ollama
    expose:
      - "11434"
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  assera-api:
    build:
      context: ./assera-api
      dockerfile: Dockerfile
      args:
        UID: ${ASSERA_UID:-1000}
        GID: ${ASSERA_GID:-1000}
    container_name: assera-api
    depends_on:
      fess:
        condition: service_healthy
      ollama:
        condition: service_healthy
    environment:
      - TZ=${TZ:-Asia/Tokyo}
      - ASSERA_API_TOKEN=${ASSERA_API_TOKEN:?ASSERA_API_TOKEN is required}
      - ASSERA_DEFAULT_MODEL=${ASSERA_DEFAULT_MODEL:-gpt-oss}
      - ASSERA_SEARCH_PROVIDER=${ASSERA_SEARCH_PROVIDER:-fess}
      - FESS_BASE_URL=${FESS_BASE_URL:-http://assera-fess:8080}
      - FESS_TIMEOUT_MS=${FESS_TIMEOUT_MS:-2000}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://assera-ollama:11434}
      - ASSERA_LLM_TIMEOUT_MS=${ASSERA_LLM_TIMEOUT_MS:-3000}
      - ASSERA_LLM_TEMPERATURE=${ASSERA_LLM_TEMPERATURE:-0.2}
      - ASSERA_LLM_TOP_P=${ASSERA_LLM_TOP_P:-0.9}
      - REQ_TIMEOUT_MS=${REQ_TIMEOUT_MS:-5000}
      - ASSERA_RATE_LIMIT_PER_MINUTE=${ASSERA_RATE_LIMIT_PER_MINUTE:-60}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_PII_MASKING=${LOG_PII_MASKING:-true}
      - DEBUG=${DEBUG:-false}
    networks:
      - assera-net
    expose:
      - "8000"
    healthcheck:
      <<: *curl-health
      test: ["CMD-SHELL", "uv run python -c \"import httpx; httpx.get('http://localhost:8000/api/v1/health', timeout=2.0)\" || exit 1"]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  assera-ui:
    build:
      context: ./assera-ui
      dockerfile: Dockerfile
      args:
        UID: ${ASSERA_UID:-1000}
        GID: ${ASSERA_GID:-1000}
    container_name: assera-ui
    depends_on:
      assera-api:
        condition: service_healthy
    environment:
      - NEXT_PUBLIC_API_BASE=${NEXT_PUBLIC_API_BASE:-/api/v1}
      - API_PROXY_URL=http://assera-api:8000
      - TZ=${TZ:-Asia/Tokyo}
    networks:
      - assera-net
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 10s
      timeout: 3s
      retries: 3
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
