# Copyright (c) 2025 CodeLibs
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Example Kubernetes Deployment for Intaste API
# This demonstrates how to use the improved health check endpoints
# for liveness and readiness probes

apiVersion: apps/v1
kind: Deployment
metadata:
  name: intaste-api
  labels:
    app: intaste-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: intaste-api
  template:
    metadata:
      labels:
        app: intaste-api
    spec:
      containers:
      - name: intaste-api
        image: ghcr.io/codelibs/intaste-api:latest
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP

        env:
        - name: INTASTE_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: intaste-secrets
              key: api-token
        - name: FESS_BASE_URL
          value: "http://fess-service:8080"
        - name: OLLAMA_BASE_URL
          value: "http://ollama-service:11434"
        - name: INTASTE_DEFAULT_MODEL
          value: "gpt-oss"

        # Liveness probe - checks if the process is alive
        # Does NOT check dependencies
        # Kubernetes will restart the pod if this fails
        livenessProbe:
          httpGet:
            path: /api/v1/health/live
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1

        # Readiness probe - checks if the service is ready to accept traffic
        # DOES check dependencies (Fess, Ollama)
        # Kubernetes will remove pod from service endpoints if this fails
        readinessProbe:
          httpGet:
            path: /api/v1/health/ready
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1

        # Startup probe - gives the app time to start up
        # Useful if the app has slow initialization
        startupProbe:
          httpGet:
            path: /api/v1/health/live
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 30  # 5s * 30 = 150s max startup time
          successThreshold: 1

        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
apiVersion: v1
kind: Service
metadata:
  name: intaste-api-service
  labels:
    app: intaste-api
spec:
  type: ClusterIP
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: intaste-api

---
# Example Secret for API token
# In production, use proper secret management (e.g., sealed-secrets, external-secrets)
apiVersion: v1
kind: Secret
metadata:
  name: intaste-secrets
type: Opaque
stringData:
  api-token: "your-secure-api-token-here"
